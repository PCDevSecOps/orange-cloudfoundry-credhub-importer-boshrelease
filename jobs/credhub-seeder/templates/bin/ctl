#!/bin/bash

set -e
set -u

PIDFILE=/var/vcap/sys/run/credhub-seeder/job.pid
LOGDIR=/var/vcap/sys/log/credhub-seeder
JOBDIR=/var/vcap/jobs/credhub-seeder

mkdir -p `dirname "$PIDFILE"`
chown vcap:vcap `dirname "$PIDFILE"`

mkdir -p "$LOGDIR"
chown vcap:vcap "$LOGDIR"

exec >> ${LOGDIR}/credhub-seeder-ctl.log
exec 2>&1

case $1 in

  start)
    echo $$ > "${PIDFILE}"

    ${JOBDIR}/bin/credhub-seeder ${JOBDIR}/config/credentials_seed.json

    # pretend we're still running to keep monit happy
    echo 1 > "${PIDFILE}"

    ;;

  stop)
    rm -f "${PIDFILE}"

    ;;

  *)
    echo "Usage: control {start|stop}" >&2

    exit 1

    ;;

esac
